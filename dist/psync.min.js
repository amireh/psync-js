define("psync/error",[],function(){var e,n,r;return e=function(e){throw"string"==typeof e?new Error(e):e},r=function(){return e.apply(this,arguments)},r.configure=function(r){n=e,e=r},r.restore=function(){e=n,n=void 0},r}),define("psync/util/evented",["require","pixy/mixins/events"],function(e){var n=e("pixy/mixins/events");return n}),define("psync/config",["require","lodash","./util/evented"],function(e){var n=e("lodash"),r=e("./util/evented"),t=n.extend,o={},i=function(){return this}();return o.adapter=null,o.unrecoverableResponseCodes=[422,400],o.persistent=!0,o.rootScope=void 0,o.debug=!1,o.optimized=!0,o.optimizer={discardDeleted:!0,singleUpdates:!0,mungeUpdates:!0},t(i,r),o.trigger=i.trigger.bind(i),o.on=i.on.bind(i),o.off=i.off.bind(i),o}),define("psync/util/wrap",[],function(){return function(e){return e?Array.isArray(e)?e:[e]:[]}}),define("psync/util/remove_by_value",[],function(){return function(e,n){var r;r=n.indexOf(e),-1!==r&&n.splice(r,1)}}),define("psync/journal/processors/create",["require","psync/config"],function(e){var n=e("psync/config");return function(e){var r=n.adapter,t={id:r.getShadowId(e),data:r.serialize(e,"create")};return t}}),define("psync/journal/processors/update",["require","psync/config"],function(e){var n=e("psync/config");return function(e){var r=n.adapter,t=r.getId(e);return t?{id:t,data:r.serialize(e,"update")}:void 0}}),define("psync/journal/processors/delete",["require","psync/config"],function(e){var n=e("psync/config");return function(e){var r=n.adapter,t=r.getId(e);return t?{id:t}:void 0}}),define("psync/journal/length_of_record",["require","psync/util/wrap"],function(e){var n=e("psync/util/wrap"),r=Object.keys,t=function(e){return r(e.operations).reduce(function(r,t){return r+=n(e.operations[t]).length},0)};return t}),define("psync/journal",["require","lodash","psync/config","psync/util/evented","psync/util/wrap","psync/util/remove_by_value","./journal/processors/create","./journal/processors/update","./journal/processors/delete","./journal/length_of_record"],function(e){var n,r=e("lodash"),t=e("psync/config"),o=e("psync/util/evented"),i=e("psync/util/wrap"),c=(e("psync/util/remove_by_value"),e("./journal/processors/create")),s=e("./journal/processors/update"),a=e("./journal/processors/delete"),u=e("./journal/length_of_record"),p=r.extend,l=r.findWhere,d=(Object.keys,function(e,n){return l(n,{path:e})}),f=function(e,n){var r={path:e,operations:{}};return n.push(r),r},y=function(e,n,r){e.operations[n]=e.operations[n]||[],e.operations[n].push(r)},v=function(e,n,r){var t,o=e.operations[n];return o&&(t=o.indexOf(r),-1!==t)?(o.splice(t,1),!0):void 0},h=function(){return this.records=[],this},g=function(){n.trigger("preprocess"),n.trigger("change")};return p(h.prototype,o,{add:function(e,n){var r,o=this.records,i=t.adapter.getPathFor(n),u=d(i,o)||f(i,o);switch(e){case"create":r=c(n);break;case"update":r=s(n);break;case"delete":r=a(n)}return r&&(r.timestamp=Date.now(),y(u,e,r),g()),r},remove:function(e,n,r){var o=t.adapter.getPathFor(n),i=d(o,this.records);return i&&v(i,e,r)?(g(),!0):void 0},clear:function(){this.isEmpty()||(this.records=[],g())},isEmpty:function(){return 0===this.length},get:function(e){return d(e,this.records)},getRecords:function(){return this.records},getEntries:function(e,n){var r=this.get(e);return r?i(r.operations[n]):void 0},toJSON:function(){return{records:this.records}},emitChange:function(){g()}}),Object.defineProperty(h.prototype,"length",{get:function(){return this.records.reduce(function(e,n){return e+=u(n)},0)}}),n=new h}),define("psync/player/resolver",["require","inflection","../error","psync/config"],function(e){var n=(e("inflection"),e("../error")),r=e("psync/config"),t={},o=function(e){return e.underscore().pluralize().camelize(!0)},i=function(e,t,i){var c,s,a=i||r.rootScope;return a?(c=a[o(e)])?(s=c.get(""+t),s||console.error('Unable to resolve scope "'+e+'" with id:',t),s):void console.error('Unknown scope "'+e+'"'):n("You must either pass a container or set one in Psync.config.rootScope.")},c=function(e,n){return n[o(e)]},s=function(e){var n,r,t,o,c=[].concat(e);for(""===c[0]&&c.shift(),o=0;o<c.length;++o)r=c[o],t=c[++o],n=i(r,t,n);return{scope:n,key:r,id:t}};return t.resolveScope=i,t.resolveScopeFromChain=s,t.resolveCollection=c,t}),define("psync/player/traverse",["require","./resolver","rsvp"],function(e){var n=e("./resolver"),r=e("rsvp"),t=Object.keys,o=n.resolveScopeFromChain,i=n.resolveCollection,c=function(e,n){var c=[];return n=n||{},e.forEach(function(e){var s,a,u,p,l,d,f=e.path.split("/"),y=f.pop();return p=o(f),s=p.scope,a=p.key,u=p.id,s?(l=i(y,s))?(d=e.operations,void t(d).forEach(function(t){var o=d[t];o.length&&(n.postProcess||n[t])&&o.forEach(function(o){var i,u=r.resolve();n[t]&&(u=n[t](s,l,o),c.push(u)),n.postProcess&&(i=n.postProcess.bind(null,{scope:s,scopeKey:a,collection:l,collectionKey:y,path:e.path,entry:o,opCode:t}),u=u.then(function(e){return i({success:!0,output:e})},function(e){return i({success:!1,output:e})}),c.push(u)),u=void 0})})):void console.warn("Unable to resolve collection at:",e.path):void console.warn("Unable to resolve scope at:",e.path)}),r.all(c)};return c}),define("psync/player",["require","pixy","rsvp","./player/traverse"],function(e){var n,r,t,o=e("pixy"),i=e("rsvp"),c=e("./player/traverse"),s=new o.Object,a=i.all,u="playbackMode",p="rollbackMode",l=function(e,n,r){var t,o=r.id;return o=""+o,t=n.get(o),t?i.resolve(o):(t=n.push({id:o}),t.fetch().then(function(){return t.get("id")},function(e){return n.remove(o),e}))},d=function(e,t,o){var c=""+o.id,s=t.get(c);return s?n===u&&r?i.resolve(c):s.fetch().then(function(){return s.get("id")}):l(e,t,o)},f=function(e,n,r){var t=""+r.id,o=n.get(t);return o&&n.remove(o),i.resolve(t)},y=function(e,t){var o;if(t.success){if(o=e.opCode,n===p)switch(e.opCode){case"create":o="delete";break;case"delete":o="create";break;case"update":o="update"}[e.collectionKey+":"+o,"change"].forEach(function(o){s.trigger(o,t.output,{path:e.path,rollingBack:n===p,selfOrigin:!!r})})}},v=function(){return this};return v.prototype.play=function(e,t){var o;return r=t,o=[],e.processed&&(n=u,o.concat([c(e.processed||[],{postProcess:y,create:l,update:d,"delete":f})])),e.dropped&&t&&(n=p,o.concat([c(e.dropped||[],{postProcess:y,create:f,update:d,"delete":l})])),a(o)},["on","off"].forEach(function(e){v.prototype[e]=s[e].bind(s)}),t=new v}),define("psync/adapters/pixy/sync",["require","pixy","lodash","psync/journal","psync/config"],function(e){var n=e("pixy"),r=e("lodash"),t=e("psync/journal"),o=e("psync/config"),i=r.result,c=r.contains,s=n.sync,a={create:"create",update:"update",patch:"update","delete":"delete"},u=function(e,n){var r,u,p,l=i(n,"isJournalled",n);return l&&(u=a[e],u&&(p=t.add(u,n))),r=s.apply(this,arguments),p&&!o.debug&&(r.then(function(){t.remove(u,n,p)}),r.then(null,function(e){e=e||{},c(o.unrecoverableResponseCodes,e.status)&&t.remove(u,n,p)})),r};return u.install=function(){n.sync=u},u.restore=function(){n.sync=s},u}),define("psync/adapters/pixy/resolver",["require","lodash"],function(e){var n,r=e("lodash"),t=r.result,o=function(e){return e.psync?t(e,"psync",e):e.collection?t(e.collection,"psync",e.collection):void 0},i=function(e,n){return e[n]?t(e,n,e):e.collection?t(e.collection,n,e.collection):void 0};return n={},n.getScope=i,n.getConfig=o,n}),define("psync/path_builder",["require","lodash","psync/error"],function(e){var n=e("lodash"),r=e("psync/error"),t=n.result,o=function(e){return"/"!==e[0]?"/"+e:e.replace(/^\/+/,"/")},i=function(e,n,c){var s,a,u=[],p=n(e);if(!p.path&&!p.collectionKey)return r("Model must configure either @psync.path or @psync.collectionKey.");if(p.path)return t(p,"path",e);if(s=p.scopeKey){if(a=c(e,s),!a)return r("Expected model scope to be found at `this.collection."+s+"`.");u.unshift(a.get("id")),u.unshift(i(a,n,c))}return u.push(p.collectionKey),o(u.join("/"))};return i}),define("psync/adapters/pixy/model",["require","psync/error","psync/adapters/pixy/resolver"],function(e){var n=e("psync/error"),r=e("psync/adapters/pixy/resolver"),t={psync:{collectionKey:void 0,path:void 0,scopeKey:void 0,scopeId:void 0},__initialize__:function(){this.collection||n("Psync model must belong to a collection.")},isJournalled:function(){return this.collection&&!!r.getConfig(this)},toPsync:function(){var e=this.toJSON();return delete e.id,e}};return t}),define("psync/adapters/pixy",["require","./pixy/sync","./pixy/resolver","psync/path_builder","./pixy/model"],function(e){var n=e("./pixy/sync"),r=e("./pixy/resolver"),t=e("psync/path_builder"),o=e("./pixy/model"),i={ModelMixin:o,install:function(){n.install()},uninstall:function(){n.restore()},getShadowId:function(e){return e.cid},getId:function(e){return e.get("id")},getPathFor:function(e){return t(e,r.getConfig,r.getScope)},serialize:function(e,n){return e.toPsync("update"===n)}};return i}),define("psync/persistence",["require","psync/config","psync/journal"],function(e){{var n,r=e("psync/config"),t=e("psync/journal"),o={},i=function(){t.isEmpty()?localStorage.removeItem("journal"):localStorage.setItem("journal",JSON.stringify(t.toJSON()))},c=o.enable=function(){n||(t.on("change",i),n=!0)},s=o.disable=function(){n&&(t.off("change",i),n=!1)};o.load=function(){var e,n=localStorage.getItem("journal");return n?(e=JSON.parse(n),t.records=e,t.emitChange(),!0):void 0}}return r.on("change",function(){r.persistent?c():s()}),o}),define("psync/journal_optimizer/config",["require","psync/config","psync/journal"],function(e){var n,r,t=e("psync/config"),o=e("psync/journal"),i=function(){n||(o.on("preprocess",r),n=!0)},c=function(){n&&(o.off("preprocess",r),n=!1)};return t.on("change",function(){t.optimized?i():c()}),function(e){r=e,t.optimized&&i()}}),define("psync/journal_optimizer",["require","psync/config","psync/journal","psync/journal/length_of_record","psync/util/wrap","psync/util/remove_by_value","./journal_optimizer/config","lodash"],function(e){var n=e("psync/config"),r=e("psync/journal"),t=e("psync/journal/length_of_record"),o=e("psync/util/wrap"),i=e("psync/util/remove_by_value"),c=e("./journal_optimizer/config"),s=e("lodash"),a={},u=s.uniq,p=s.where,l=s.findWhere,d=s.merge,f=s.sortBy,y=s.map,v=function(e){var n=e.operations.update,r=n.map(function(e){return e.id});e.operations.update=u(r).map(function(e){var r=p(n,{id:e});return 1===r.length?r[0]:(r=f(r,"timestamp"),r[r.length-1])})},h=function(e){y(e.operations.update,"id").forEach(function(n){var r,t=e.operations.update,o=l(e.operations.create,{id:n});o&&(r=l(e.operations.update,{id:n}),d(o.data,r.data),i(r,t))})},g=function(){var e=r.records.map(function(e){return e.path});e.forEach(function(e){var n=l(r.records,{path:e});n&&!t(n)&&i(n,r.records)})},m=function(e){var n=["create","update"],r=function(e,n){var t=l(e,{id:n});if(t)return i(t,e),r(e,n)};e.operations["delete"].forEach(function(t){n.forEach(function(n){var o=p(e.operations[n],{id:t.id});o.length&&r(e.operations[n],t.id)})})},j=function(){r.getRecords().forEach(function(e){var r,t,i;n.optimizer.discardDeleted&&(r=o(e.operations.delete).length,r&&m(e)),i=o(e.operations.update).length,i&&(n.optimizer.singleUpdates&&v(e),t=o(e.operations.create).length,n.optimizer.mungeUpdates&&t&&h(e))}),g()};return c(j),a}),define("psync",["require","./psync/error","./psync/journal","./psync/player","./psync/config","./psync/adapters/pixy","./psync/persistence","./psync/journal_optimizer"],function(e){{var n,r=e("./psync/error"),t=e("./psync/journal"),o=e("./psync/player"),i=e("./psync/config"),c=e("./psync/adapters/pixy"),s=e("./psync/persistence");e("./psync/journal_optimizer")}return n={},n.Journal=t,n.Player=o,n.onError=r,n.Persistence=s,n.Adapters={Pixy:c},n.configure=function(e,n){var t;return i.hasOwnProperty(e)?(t=i[e],void 0!==n&&(i[e]=n,i.trigger("change")),t):r("Unknown Psync configuration property '"+e+"'")},n});