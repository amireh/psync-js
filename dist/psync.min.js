define("psync/error",[],function(){var e,n,r;return e=function(e){throw"string"==typeof e?new Error(e):e},r=function(){return e.apply(this,arguments)},r.configure=function(r){n=e,e=r},r.restore=function(){e=n,n=void 0},r}),define("psync/util/evented",["require","pixy/mixins/events"],function(e){var n=e("pixy/mixins/events");return n}),define("psync/config",["require","lodash","./util/evented"],function(e){var n=e("lodash"),r=e("./util/evented"),o=n.extend,t={},i=function(){return this}();return t.enabled=!0,t.adapter=null,t.unrecoverableResponseCodes=[422,400],t.persistent=!0,t.rootScope=void 0,t.debug=!1,t.optimized=!0,t.optimizer={discardEmptyRecords:!0,discardDeleted:!0,singleUpdates:!0,mungeUpdates:!0},o(i,r),t.trigger=i.trigger.bind(i),t.on=i.on.bind(i),t.off=i.off.bind(i),t}),define("psync/util/wrap",[],function(){return function(e){return e?Array.isArray(e)?e:[e]:[]}}),define("psync/util/remove_by_value",[],function(){return function(e,n){var r;return n&&(r=n.indexOf(e),-1!==r)?(n.splice(r,1),!0):void 0}}),define("psync/journal/processors/create",["require","psync/config"],function(e){var n=e("psync/config");return function(e){var r=n.adapter,o={id:r.getShadowId(e),data:r.serialize(e,"create")};return o}}),define("psync/journal/processors/update",["require","psync/config"],function(e){var n=e("psync/config");return function(e){var r=n.adapter,o=r.getId(e);return o?{id:o,data:r.serialize(e,"update")}:void 0}}),define("psync/journal/processors/delete",["require","psync/config"],function(e){var n=e("psync/config");return function(e){var r=n.adapter,o=r.getId(e);return o?{id:o}:void 0}}),define("psync/journal/length_of_record",["require","psync/util/wrap"],function(e){var n=e("psync/util/wrap"),r=Object.keys,o=function(e){return r(e.operations).reduce(function(r,o){return r+=n(e.operations[o]).length},0)};return o}),define("psync/journal",["require","lodash","psync/config","psync/util/evented","psync/util/wrap","psync/util/remove_by_value","./journal/processors/create","./journal/processors/update","./journal/processors/delete","./journal/length_of_record"],function(e){var n,r=e("lodash"),o=e("psync/config"),t=e("psync/util/evented"),i=e("psync/util/wrap"),c=(e("psync/util/remove_by_value"),e("./journal/processors/create")),s=e("./journal/processors/update"),a=e("./journal/processors/delete"),u=e("./journal/length_of_record"),p=r.extend,l=r.findWhere,d=Object.keys,f=function(e,n){return l(n,{path:e})},y=function(e,n){var r={path:e,operations:{}};return n.push(r),r},v=function(e,n,r){e.operations[n]=e.operations[n]||[],e.operations[n].push(r)},h=function(){return this.records=[],this},g=function(){n.trigger("preprocess"),n.trigger("change")};return p(h.prototype,t,{add:function(e,n){var r,t=this.records,i=o.adapter.getPathFor(n),u=f(i,t)||y(i,t);switch(e){case"create":r=c(n);break;case"update":r=s(n);break;case"delete":r=a(n)}return r&&(r.timestamp=Date.now(),v(u,e,r),g()),r},remove:function(e,n,r){var t=o.adapter.getPathFor(n),i=f(t,this.records);return this.removeEntry(i,e,r)},removeEntry:function(e,n,r){e&&e.operations&&r},discardProcessed:function(e){e.forEach(function(e){d(e.operations).forEach(function(n){var r=e.operations[n];r.forEach(function(e){var r;switch(n){case"create":r=e.shadow_id;break;case"update":case"delete":r=e.id}})})})},clear:function(){this.isEmpty()||(this.records=[],g())},isEmpty:function(){return 0===this.length},get:function(e){return f(e,this.records)},getRecords:function(){return this.records},getEntries:function(e,n){var r=this.get(e);return r?i(r.operations[n]):void 0},toJSON:function(){return{records:this.records}},emitChange:function(){g()}}),Object.defineProperty(h.prototype,"length",{get:function(){return this.records.reduce(function(e,n){return e+=u(n)},0)}}),n=new h}),define("psync/player/resolver",["require","inflection","../error","psync/config"],function(e){var n=(e("inflection"),e("../error")),r=e("psync/config"),o={},t=function(e){return e.underscore().pluralize().camelize(!0)},i=function(e,o,i){var c,s,a=i||r.rootScope;return a?(c=a[t(e)])?(s=c.get(""+o),s||console.error('Unable to resolve scope "'+e+'" with id:',o),s):void console.error('Unknown scope "'+e+'"'):n("You must either pass a container or set one in Psync.config.rootScope.")},c=function(e,n){return n[t(e)]},s=function(e){var n,r,o,t,c=[].concat(e);for(""===c[0]&&c.shift(),t=0;t<c.length;++t)r=c[t],o=c[++t],n=i(r,o,n);return{scope:n,key:r,id:o}};return o.resolveScope=i,o.resolveScopeFromChain=s,o.resolveCollection=c,o}),define("psync/player/traverse",["require","./resolver","rsvp"],function(e){var n=e("./resolver"),r=e("rsvp"),o=Object.keys,t=n.resolveScopeFromChain,i=n.resolveCollection,c=function(e,n){var c=[];return n=n||{},e.forEach(function(e){var s,a,u,p,l,d,f=e.path.split("/"),y=f.pop();return p=t(f),s=p.scope,a=p.key,u=p.id,s?(l=i(y,s))?(d=e.operations,void o(d).forEach(function(o){var t=d[o];t.length&&(n.postProcess||n[o])&&t.forEach(function(t){var i,u=r.resolve();n[o]&&(u=n[o](s,l,t),c.push(u)),n.postProcess&&(i=n.postProcess.bind(null,{scope:s,scopeKey:a,collection:l,collectionKey:y,path:e.path,entry:t,opCode:o}),u=u.then(function(e){return i({success:!0,output:e})},function(e){return i({success:!1,output:e})}),c.push(u)),u=void 0})})):void console.warn("Unable to resolve collection at:",e.path):void console.warn("Unable to resolve scope at:",e.path)}),r.all(c)};return c}),define("psync/player",["require","pixy","rsvp","./player/traverse"],function(e){var n,r,o,t=e("pixy"),i=e("rsvp"),c=e("./player/traverse"),s=new t.Object,a=i.all,u="playbackMode",p="rollbackMode",l=function(e,n,r){var o,t=r.id;return t=""+t,o=n.get(t),o?i.resolve(t):(o=n.push({id:t}),o.fetch().then(function(){return o.get("id")},function(e){return n.remove(t),e}))},d=function(e,o,t){var c=""+t.id,s=o.get(c);return s?n===u&&r?i.resolve(c):s.fetch().then(function(){return s.get("id")}):l(e,o,t)},f=function(e,n,r){var o=""+r.id,t=n.get(o);return t&&n.remove(t),i.resolve(o)},y=function(e,o){var t;if(o.success){if(t=e.opCode,n===p)switch(e.opCode){case"create":t="delete";break;case"delete":t="create";break;case"update":t="update"}[e.collectionKey+":"+t,"change"].forEach(function(t){s.trigger(t,o.output,{path:e.path,rollingBack:n===p,selfOrigin:!!r})})}},v=function(){return this};return v.prototype.play=function(e,o){var t;return r=o,t=[],e.processed&&(n=u,t.concat([c(e.processed||[],{postProcess:y,create:l,update:d,"delete":f})])),e.dropped&&o&&(n=p,t.concat([c(e.dropped||[],{postProcess:y,create:f,update:d,"delete":l})])),a(t)},["on","off"].forEach(function(e){v.prototype[e]=s[e].bind(s)}),o=new v}),define("psync/configure",["require","./config","./error"],function(e){var n=e("./config"),r=e("./error"),o={},t=function(e,t){var i;return n.hasOwnProperty(e)?(i=n[e],void 0!==t&&(o[e]=n[e],n[e]=t,n.trigger("change",e,t,o[e])),i):r("Unknown Psync configuration property '"+e+"'")};return t.restore=function(e){t(e,o[e])},t}),define("psync/adapters/pixy/sync",["require","pixy","lodash","psync/journal","psync/config"],function(e){var n=e("pixy"),r=e("lodash"),o=e("psync/journal"),t=e("psync/config"),i=r.result,c=r.contains,s=n.sync,a={create:"create",update:"update",patch:"update","delete":"delete"},u=function(e,n){var r,u,p,l=i(n,"isJournalled",n);return l&&(u=a[e],u&&(p=o.add(u,n))),r=s.apply(this,arguments),p&&!t.debug&&(r.then(function(){o.remove(u,n,p)}),r.then(null,function(e){e=e||{},c(t.unrecoverableResponseCodes,e.status)&&o.remove(u,n,p)})),r};return u.install=function(){n.sync=u},u.restore=function(){n.sync=s},u}),define("psync/adapters/pixy/resolver",["require","lodash"],function(e){var n,r=e("lodash"),o=r.result,t=function(e){return e.psync?o(e,"psync",e):e.collection?o(e.collection,"psync",e.collection):void 0},i=function(e,n){return e[n]?o(e,n,e):e.collection?o(e.collection,n,e.collection):void 0};return n={},n.getScope=i,n.getConfig=t,n}),define("psync/path_builder",["require","lodash","psync/error"],function(e){var n=e("lodash"),r=e("psync/error"),o=n.result,t=function(e){return"/"!==e[0]?"/"+e:e.replace(/^\/+/,"/")},i=function(e,n,c){var s,a,u=[],p=n(e);if(!p.path&&!p.collectionKey)return r("Model must configure either @psync.path or @psync.collectionKey.");if(p.path)return o(p,"path",e);if(s=p.scopeKey){if(a=c(e,s),!a)return r("Expected model scope to be found at `this.collection."+s+"`.");u.unshift(a.get("id")),u.unshift(i(a,n,c))}return u.push(p.collectionKey),t(u.join("/"))};return i}),define("psync/adapters/pixy/model",["require","psync/error","psync/adapters/pixy/resolver"],function(e){var n=e("psync/error"),r=e("psync/adapters/pixy/resolver"),o={psync:{collectionKey:void 0,path:void 0,scopeKey:void 0,scopeId:void 0},__initialize__:function(){this.collection||n("Psync model must belong to a collection.")},isJournalled:function(){return this.collection&&!!r.getConfig(this)},toPsync:function(){var e=this.toJSON();return delete e.id,e}};return o}),define("psync/adapters/pixy",["require","./pixy/sync","./pixy/resolver","psync/path_builder","./pixy/model"],function(e){var n=e("./pixy/sync"),r=e("./pixy/resolver"),o=e("psync/path_builder"),t=e("./pixy/model"),i={ModelMixin:t,install:function(){n.install()},uninstall:function(){n.restore()},getShadowId:function(e){return e.cid},getId:function(e){return e.get("id")},getPathFor:function(e){return o(e,r.getConfig,r.getScope)},serialize:function(e,n){return e.toPsync("update"===n)}};return i}),define("psync/persistence",["require","psync/config","psync/journal"],function(e){{var n,r=e("psync/config"),o=e("psync/journal"),t={},i=function(){o.isEmpty()?localStorage.removeItem("journal"):localStorage.setItem("journal",JSON.stringify(o.toJSON()))},c=t.enable=function(){n||(o.on("change",i),n=!0)},s=t.disable=function(){n&&(o.off("change",i),n=!1)};t.load=function(){var e,n=localStorage.getItem("journal");return n?(e=JSON.parse(n),o.records=e.records||[],o.emitChange(),!0):void 0}}return r.on("change",function(){r.persistent?c():s()}),t}),define("psync/journal_optimizer/config",["require","psync/config","psync/journal"],function(e){var n,r,o=e("psync/config"),t=e("psync/journal"),i=function(){n||(t.on("preprocess",r),n=!0)},c=function(){n&&(t.off("preprocess",r),n=!1)};return o.on("change",function(){o.optimized?i():c()}),function(e){r=e,o.optimized&&i()}}),define("psync/journal_optimizer",["require","psync/config","psync/journal","psync/journal/length_of_record","psync/util/wrap","psync/util/remove_by_value","./journal_optimizer/config","lodash"],function(e){var n=e("psync/config"),r=e("psync/journal"),o=e("psync/journal/length_of_record"),t=e("psync/util/wrap"),i=e("psync/util/remove_by_value"),c=e("./journal_optimizer/config"),s=e("lodash"),a={},u=s.uniq,p=s.where,l=s.findWhere,d=s.merge,f=s.sortBy,y=s.map,v=function(e){var n=e.operations.update,r=n.map(function(e){return e.id});e.operations.update=u(r).map(function(e){var r=p(n,{id:e});return 1===r.length?r[0]:(r=f(r,"timestamp"),r[r.length-1])})},h=function(e){y(e.operations.update,"id").forEach(function(n){var r,o=e.operations.update,t=l(e.operations.create,{id:n});t&&(r=l(e.operations.update,{id:n}),d(t.data,r.data),i(r,o))})},g=function(){var e=r.records.map(function(e){return e.path});e.forEach(function(e){var n=l(r.records,{path:e});n&&!o(n)&&i(n,r.records)})},m=function(e){var n=["create","update"],r=function(e,n){var o=l(e,{id:n});if(o)return i(o,e),r(e,n)};e.operations["delete"].forEach(function(o){n.forEach(function(n){var t=p(e.operations[n],{id:o.id});t.length&&r(e.operations[n],o.id)})})},j=function(){r.getRecords().forEach(function(e){var r,o,i;n.optimizer.discardDeleted&&(r=t(e.operations.delete).length,r&&m(e)),i=t(e.operations.update).length,i&&(n.optimizer.singleUpdates&&v(e),o=t(e.operations.create).length,n.optimizer.mungeUpdates&&o&&h(e))}),n.optimizer.discardEmptyRecords&&g()};return c(j),a}),define("psync",["require","./psync/error","./psync/journal","./psync/player","./psync/config","./psync/configure","./psync/adapters/pixy","./psync/persistence","./psync/journal_optimizer"],function(e){{var n,r=e("./psync/error"),o=e("./psync/journal"),t=e("./psync/player"),i=e("./psync/config"),c=e("./psync/configure"),s=e("./psync/adapters/pixy"),a=e("./psync/persistence");e("./psync/journal_optimizer")}return n={},n.configure=c,n.Journal=o,n.Player=t,n.onError=r,n.Persistence=a,n.Adapters={Pixy:s},i.on("change",function(e,n,r){("enabled"===e||"adapter"===e)&&i.adapter&&(n&&!r?i.adapter.install():!n&&r&&i.adapter.uninstall())}),n});